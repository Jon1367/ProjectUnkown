'use strict';

var request = require('supertest');
var express = require('express');
var serveAngular = require('./index');

describe('serve-angular', function() {
  it('should serve the Angular template', function(done) {
    var app = express()
      .use(serveAngular({ layout: __dirname + '/layout.html' }));

    request(app)
      .get('/')
      .expect(200)
      .expect('<!-- APP SCRIPTS -->')
      .end(function(err){
        if (err) throw err;
        done();
      });
  });

  it('should detect a potential file with an argument', function(done) {
    var app = express()
      .use(serveAngular({ layout: __dirname + '/layout.html' }));

    request(app)
      .get('/test.html?param=doh')
      .expect(404)
      .end(function(err){
        if (err) throw err;
        done();
      });
  });

  it('should send AngularJS layout even if their is arguments in the request URL', function(done) {
    var app = express()
      .use(serveAngular({ layout: __dirname + '/layout.html' }));

    request(app)
      .get('/test?param=doh')
      .expect(200)
      .expect('<!-- APP SCRIPTS -->')
      .end(function(err){
        if (err) throw err;
        done();
      });
  });

  it('should ignore if the request is a file', function(done) {
    var app = express()
      .use(serveAngular({ layout: __dirname + '/layout.html' }));

    request(app)
      .get('/layout/test.html')
      .expect(404)
      .end(function(err){
        if (err) throw err;
        done();
      });
  });

  it('should retrieve the error if the layout file is missing', function(done) {
    var app = express()
      .use(serveAngular({ layout: __dirname + '/missingFile.html' }));

    /*jshint ignore:start */
    // The next must stay or the error handling middleware will not be recognized
    app.use(function(err, req, res, next) {
      res.status(500);
      res.json(err);
      res.end();
    });
    /*jshint ignore:end */

    request(app)
      .get('/')
      .expect(500)
      .end(function(err){
        if (err) throw err;
        done();
      });
  });

  it('should include js files with the app.js first', function(done) {
    var app = express()
      .use(serveAngular({
        layout: __dirname + '/layout.html',
        public: __dirname + '/fakePublic'
      }));

    request(app)
      .get('/')
      .expect(200)
      .expect('<script src="/js/app.js"></script><script src="/js/aaa.js"></script>')
      .end(function(err){
        if (err) throw err;
        done();
      });
  });
});