'use strict';

var fs = require('fs');
var glob = require('glob');

module.exports = function serveAngular(options) {
  return function(req, res, next) {
    // Default ignore regex to detect if the request looks like a file
    // This will prevent the infinite loops from a missing Angular template
    if (!options.ignoreRegex) options.ignoreRegex = /\.[a-z]+$/i;
    if (!options.scripts) options.scripts = '/js';
    if (!options.scriptsReplace) options.scriptsReplace = '<!-- APP SCRIPTS -->';

    // Ignore the requests that looks like a file
    if (options.ignoreRegex.test(req.url.split('?')[0])) return next();

    res.setHeader('content-type', 'text/html');

    fs.readFile(options.layout, function(err, content) {
      if (err) return next(err);
      content = content.toString();

      if (!options.scripts || !options.public) {
        res.write(content);
        res.end();
        return;
      }

      glob(options.public + options.scripts  + '/**/*.js', function(err, files) {
        if (err) return next(err);

        var scripts = '';
        var startPos = options.public.length + options.scripts.length;

        files.forEach(function(file, i) {
          files[i] = file.substr(startPos);
        });

        files.forEach(function(file) {
          if (/\/app\.js$/.test(file)) {
            scripts += '<script src="' + options.scripts + file + '"></script>';
          }
        });

        files.forEach(function(file) {
          if (!/\/app\.js$/.test(file)) {
            scripts += '<script src="' + options.scripts + file + '"></script>';
          }
        });

        content = content.replace(options.scriptsReplace, scripts);

        res.write(content);
        res.end();
      });
    });
  };
};